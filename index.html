<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>薪昌股份有限公司 - 滾輪統計系統 V3</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #333; }
        
        /* 頁籤樣式 */
        .tab-group { margin-top: 20px; border-bottom: 2px solid #007bff; display: flex; gap: 5px; }
        .tab { padding: 12px 25px; cursor: pointer; border: 1px solid #ddd; border-bottom: none; background: #eee; border-radius: 8px 8px 0 0; }
        .tab.active { background: #007bff; color: white; font-weight: bold; border-color: #007bff; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; background: #fff; }
        .tab-content.active { display: block; }
        
        /* 表單樣式優化 */
        .conveyor-item { border: 1px solid #ced4da; padding: 20px; margin-bottom: 15px; border-radius: 8px; background: #fafafa; position: relative; }
        .remove-btn { position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 5px 12px; cursor: pointer; border-radius: 4px; }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
        .form-group { flex: 1; min-width: 180px; } /* 增加最小寬度防止重疊 */
        label { display: block; font-size: 14px; margin-bottom: 8px; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #bbb; font-size: 14px; box-sizing: border-box; }
        
        /* 表格樣式 */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; }
        th { background-color: #e9ecef; }
        .btn-main { background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-export { background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; float: right; }
        .footer-space { margin-top: 20px; font-weight: bold; display: flex; justify-content: space-around; padding: 20px; border-top: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h1>薪昌股份有限公司</h1>
    <h2>帶運機滾輪統計表 請購單</h2>

    <div id="inputArea">
        <div id="conveyorList"></div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-main" style="background: #6c757d;" onclick="addConveyor()">+ 新增帶運機</button>
            <button class="btn-main" onclick="calculateAll()">1. 生成統計數據</button>
        </div>
    </div>

    <div id="resultWrapper" style="display:none;">
        <div class="tab-group">
            <div class="tab active" onclick="switchTab(0)">成品明細 (按機器)</div>
            <div class="tab" onclick="switchTab(1)">配件總計表 (BOM)</div>
            <button class="btn-export" onclick="exportToExcel()">匯出 Excel</button>
        </div>

        <div id="tab0" class="tab-content active">
            <div id="detailContent"></div>
        </div>
        <div id="tab1" class="tab-content">
            <div id="summaryContent"></div>
        </div>
    </div>
</div>

<script>
    let conveyorCount = 0;
    let excelData = []; // 全域變數存放配件資料

    function addConveyor() {
        conveyorCount++;
        const container = document.getElementById('conveyorList');
        const div = document.createElement('div');
        div.className = 'conveyor-item';
        div.id = `item-${conveyorCount}`;
        div.innerHTML = `
            <button class="remove-btn" onclick="this.parentElement.remove()">移除</button>
            <div class="form-row">
                <div class="form-group">
                    <label>帶運機名稱</label>
                    <input type="text" class="name" value="帶運機-${conveyorCount}">
                </div>
                <div class="form-group">
                    <label>皮帶寬度</label>
                    <select class="width">
                        <option value="750W">750W</option>
                        <option value="900W">900W</option>
                        <option value="1000W">1000W</option>
                        <option value="1050W">1050W</option>
                        <option value="1200W">1200W</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>帶運機種類</label>
                    <select class="type">
                        <option value="main">主帶運機</option>
                        <option value="storage">入庫帶運機</option>
                        <option value="sorting">分料帶運機</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>數量</label>
                    <input type="number" class="qty" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>長度 (頭尾輪距離 mm)</label>
                    <input type="number" class="length" placeholder="例如: 15000">
                </div>
                <div class="form-group">
                    <label>滾輪種類</label>
                    <select class="rollerType">
                        <option value="chain">吊鍊</option>
                        <option value="bracket">托架</option>
                    </select>
                </div>
            </div>
        `;
        container.appendChild(div);
    }
    addConveyor();

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === idx));
    }

    function calculateAll() {
        const items = document.querySelectorAll('.conveyor-item');
        let detailHtml = "";
        let partMap = {};

        items.forEach(item => {
            const name = item.querySelector('.name').value;
            const beltWidth = item.querySelector('.width').value;
            const type = item.querySelector('.type').value;
            const qty = parseInt(item.querySelector('.qty').value) || 0;
            const length = parseInt(item.querySelector('.length').value) || 0;
            const rollerType = item.querySelector('.rollerType').value;

            let machineItems = {};
            const addMI = (itemName, count) => {
                const fullName = `${beltWidth}${itemName}`;
                machineItems[fullName] = (machineItems[fullName] || 0) + count;
            };

            // 邏輯計算
            if (type === 'main' || type === 'storage') {
                let fwd = (rollerType === 'chain') ? "吊鏈式前行滾輪組" : "托架前行輪組(40度)";
                let b_norm = (rollerType === 'chain') ? "吊鏈式回程滾輪組(一般)" : "吊片式回程滾輪組(一般)";
                let b_spir = (rollerType === 'chain') ? "吊鏈式回程滾輪組(螺旋)" : "吊片式回程滾輪組(螺旋)";
                
                let fCount = (type === 'main') ? Math.floor((length - 7000) / 1000) : Math.floor((length - 4000) / 1000);
                let bCount = Math.floor((length - 2000) / 2000);

                addMI(fwd, fCount * qty);
                if (bCount > 0) {
                    addMI(b_spir, 1 * qty);
                    addMI(b_norm, (bCount - 1) * qty);
                }
                // 預備用
                addMI("吊鏈式回程滾輪組(一般)", 2 * qty);
                addMI("托架前行輪組(40度)", 1 * qty);
                addMI("托架緩衝輪組(40度)", 1 * qty);
            }

            if (type === 'main') {
                addMI("托架緩衝輪組(40度)", 8 * qty); addMI("托架前行輪組(40度)", 3 * qty);
                addMI("托架前行輪組(35度)", 1 * qty); addMI("托架前行輪組(30度)", 1 * qty);
            } else if (type === 'storage') {
                addMI("托架緩衝輪組(40度)", 2 * qty); addMI("托架前行輪組(40度)", 1 * qty);
                addMI("托架緩衝輪組(35度)", 1 * qty); addMI("托架緩衝輪組(30度)", 1 * qty);
            } else if (type === 'sorting') {
                addMI("托架緩衝輪組(30度)", 2 * qty); addMI("托架緩衝輪組(25度)", 1 * qty);
                addMI("托架前行輪組(30度)", 1 * qty); addMI("自動調心前進滾輪組(25度-單向)", 1 * qty);
                addMI("吊片式回程滾輪組(一般)", 1 * qty); addMI("吊片式回程滾輪組(螺旋)", 1 * qty);
            }

            // 渲染明細表格
            detailHtml += `<h4>${name} [寬度:${beltWidth}]</h4><table><tr><th>成品組件名稱</th><th>數量</th></tr>`;
            for (let k in machineItems) {
                const n = machineItems[k];
                detailHtml += `<tr><td>${k}</td><td>${n} 組</td></tr>`;
                
                // BOM 拆解邏輯 (同步處理寬度標籤)
                const pureName = k.replace(beltWidth, ""); // 移除寬度標頭以便判斷邏輯
                const prefix = beltWidth;

                if (pureName.includes("吊片式")) {
                    partMap[k] = (partMap[k]||0)+n;
                    partMap[prefix + "吊片"] = (partMap[prefix + "吊片"]||0)+n*2;
                } else if (pureName.includes("吊鏈式")) {
                    partMap[k] = (partMap[k]||0)+n;
                    let hook = pureName.includes("前行") ? "吊鍊式前行輪掛勾" : "吊鍊式回程輪掛勾";
                    partMap[prefix + hook] = (partMap[prefix + hook]||0)+n*2;
                } else if (pureName.includes("托架") || pureName.includes("自動調心")) {
                    let deg = pureName.match(/\d+度/)[0];
                    let bracketType = pureName.includes("自動調心") ? "自動調心前進滾輪組支架" : "前進滾輪組支架";
                    partMap[`${prefix}${bracketType}(${deg})`] = (partMap[`${prefix}${bracketType}(${deg})`]||0)+n;
                    let rollerType = pureName.includes("緩衝") ? "前進滾輪(緩衝)" : "前進滾輪(一般)";
                    partMap[prefix + rollerType] = (partMap[prefix + rollerType]||0)+n*3;
                    if(pureName.includes("自動調心")) partMap[prefix + "側擋輪"] = (partMap[prefix + "側擋輪"]||0)+n*2;
                }
            }
            detailHtml += `</table>`;
        });

        document.getElementById('detailContent').innerHTML = detailHtml;

        // 配件表渲染與存入全域變數
        excelData = [];
        let summaryHtml = `<table><tr><th>配件名稱</th><th>數量</th><th>單位</th></tr>`;
        Object.keys(partMap).sort().forEach(key => {
            let unit = "組";
            if (key.includes("支架")) unit = "支";
            else if (key.includes("吊片")) unit = "片";
            else if (key.includes("掛勾")) unit = "只";
            else if (key.includes("滾輪(") || key.includes("側擋輪")) unit = "顆";
            
            summaryHtml += `<tr><td>${key}</td><td>${partMap[key]}</td><td>${unit}</td></tr>`;
            excelData.push([key, partMap[key], unit]);
        });
        summaryHtml += `</table>`;
        document.getElementById('summaryContent').innerHTML = summaryHtml;
        document.getElementById('resultWrapper').style.display = "block";
    }

    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        const wsData = [
            ["薪昌股份有限公司"],
            ["帶運機滾輪統計表 請購單"],
            [],
            ["配件名稱", "數量", "單位", "備註"]
        ];

        excelData.forEach(row => wsData.push([row[0], row[1], row[2], ""]));
        wsData.push([], ["申請人：__________", "", "部門主管：__________", "", "廠務部：__________"]);

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!cols'] = [{ wch: 45 }, { wch: 10 }, { wch: 10 }, { wch: 15 }];
        ws['!merges'] = [{ s:{r:0,c:0}, e:{r:0,c:3} }, { s:{r:1,c:0}, e:{r:1,c:3} }];

        XLSX.utils.book_append_sheet(wb, ws, "請購單總計");
        XLSX.writeFile(wb, `薪昌滾輪統計_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>
